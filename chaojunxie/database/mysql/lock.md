## 锁

+ 全局锁

  全局锁就是对整个数据库加锁。MySql提供了FTWRL(flush tables with read lock)命令进行全局读锁。使用了这个命令，整数据库处于只可读状态。

  进行数据备份的时候，非InnoDB的引擎需要使用到FTWRL来进行备份，因为只有这样的操作才能保证全局的备份是处于同一个逻辑时间点的。InnoDB的备份，是通过启动一个隔离级别为可重复读的事务来进行的。

+ 表级锁

  + 表锁

    锁住整个表。在没有更细粒度锁之前，表锁是最常用的处理并发的方式。

  + 元数据锁(meta data lock MDL)

    MDL不需要显式调用，访问表的时候会自动加上。事务提交了以后，MDL会被释放。

    CRUD会获取读锁，表结构修改需要获取写锁。

    因为这样的机制可能会导致小表修改表结构，整个库挂掉的情况。

    例如：

    |      Session A      |  session b  |      session c      |
    | :-----------------: | :---------: | :-----------------: |
    | select * from table |             |                     |
    |                     | Alter table |                     |
    |                     |             | Select * from table |

    session A获得MDL读锁。session b需要获取写锁，所以会被挂起。session c需要读锁，因为session b，所以会被挂起。如果session a一直不提交，会导致所有的请求都挂住。如果客户端有重试机制的话，数据库的线程池也会被挤爆。

+ 行锁

  MySql的行锁是由存储引擎来实现的。InnoDB实现了行锁。使用了两阶段锁协议，也就是锁在需要的时候才加上，但是回到事务提交的时候，一次全部释放。所以，在业务逻辑里面，尽量把冲突高的部分往后方，减少锁持有时间。

  InnoDB提供了主动死锁检测，但是需要耗费额外的资源。